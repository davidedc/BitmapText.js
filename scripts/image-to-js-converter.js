// Generalized Image to JS Converter
// Converts PNG and QOI files to JavaScript files containing base64-encoded data
//
// This script solves cross-origin issues in browsers by embedding image data in JS files.
// When loading images from filesystem, browsers consider each as a separate domain,
// making them tainted as cross-origin. Loading the same data from JS files avoids this issue.
//
// This converter handles both:
// - PNG files (for browser usage)
// - QOI files (for Node.js usage)
//
// The generated JS files call FontLoader.registerAtlasPackage() to register the base64 data.
// Atlas positioning data is NOT included - it will be reconstructed at runtime by TightAtlasReconstructor.

const fs = require('fs');
const path = require('path');

// Get directory parameter or default to 'font-assets'
const targetDir = process.argv[2] || 'font-assets';

// Parse command line options
let processQOI = false;
let processPNG = false;
let qoiSuffix = '-qoi'; // Suffix to distinguish QOI JS files from PNG JS files
let pngSuffix = '-png'; // Suffix to distinguish PNG JS files from QOI JS files

// Check command line arguments
const args = process.argv.slice(3);
for (const arg of args) {
  switch (arg) {
    case '--qoi':
      processQOI = true;
      break;
    case '--png':
      processPNG = true;
      break;
    case '--all':
      processQOI = true;
      processPNG = true;
      break;
    case '--help':
    case '-h':
      console.log('Usage: node image-to-js-converter.js [directory] [options]');
      console.log('');
      console.log('Options:');
      console.log('  --png              Process PNG files only');
      console.log('  --qoi              Process QOI files only');
      console.log('  --all              Process both PNG and QOI files (default)');
      console.log('  --help             Show this help message');
      console.log('');
      console.log('Examples:');
      console.log('  node image-to-js-converter.js font-assets --all');
      console.log('  node image-to-js-converter.js font-assets --qoi');
      process.exit(0);
      break;
    default:
      console.error(`Unknown option: ${arg}`);
      console.error('Use --help for usage information');
      process.exit(1);
  }
}

// Default to processing all if no specific format specified
if (!processQOI && !processPNG) {
  processQOI = true;
  processPNG = true;
}

function log(message) {
    const timestamp = new Date().toISOString().replace('T', ' ').substring(0, 19);
    console.log(`[${timestamp}] ${message}`);
}

log(`Starting image to JS conversion in directory: ${targetDir}`);
log(`Processing PNG: ${processPNG}, Processing QOI: ${processQOI}`);

// Check dependencies
try {
    require('fs');
    require('path');
} catch (error) {
    log(`ERROR: Required Node.js modules not available: ${error.message}`);
    log('Make sure Node.js is properly installed');
    process.exit(1);
}

// Check if target directory exists
if (!fs.existsSync(targetDir)) {
    log(`ERROR: Directory ${targetDir} does not exist`);
    process.exit(1);
}

// Function to convert image file to base64
function imageToBase64(filePath) {
    const imageData = fs.readFileSync(filePath);
    return Buffer.from(imageData).toString('base64');
}

// Function to generate IDString from filename (removes atlas- prefix and file extension)
function generateIDString(filename, extension) {
    return filename.replace(extension, '').replace('atlas-', '');
}

// Function to generate JS content for atlas image data (no positioning data)
function generateJSContent(idString, base64Data, imageType, originalFilename) {
    const mimeType = imageType === 'png' ? 'image/png' : 'application/qoi';

    return `// Atlas data for ${originalFilename}
// Generated by image-to-js-converter.js
// MIME type: ${mimeType}
// Encoding: base64
// Format: Variable-width cells (Atlas format)
// Positioning data will be reconstructed at runtime using TightAtlasReconstructor

// Register atlas package (base64 only - no positioning data)
if (typeof FontLoader !== 'undefined' && FontLoader.registerAtlasPackage) {
    FontLoader.registerAtlasPackage(
        '${idString}',
        '${base64Data}'
    );
} else if (typeof FontLoaderBase !== 'undefined' && FontLoaderBase.registerAtlasPackage) {
    FontLoaderBase.registerAtlasPackage(
        '${idString}',
        '${base64Data}'
    );
} else {
    console.warn('FontLoader/FontLoaderBase.registerAtlasPackage not available - atlas data for ${idString} not registered');
}
`;
}

let totalProcessed = 0;

// Process PNG files if requested
if (processPNG) {
    const pngFiles = fs.readdirSync(targetDir).filter(file =>
        path.extname(file).toLowerCase() === '.png' &&
        file.startsWith('atlas-')
    );

    log(`Found ${pngFiles.length} PNG atlas files to process`);

    pngFiles.forEach(pngFile => {
        const pngPath = path.join(targetDir, pngFile);
        const base64Data = imageToBase64(pngPath);
        const idString = generateIDString(pngFile, '.png');
        const jsFileName = pngFile.replace('.png', `${pngSuffix}.js`);
        const jsFilePath = path.join(targetDir, jsFileName);

        const jsContent = generateJSContent(idString, base64Data, 'png', pngFile);

        fs.writeFileSync(jsFilePath, jsContent);
        log(`Processed PNG: ${pngFile} -> ${jsFileName}`);

        totalProcessed++;
    });
}

// Process QOI files if requested
if (processQOI) {
    const qoiFiles = fs.readdirSync(targetDir).filter(file =>
        path.extname(file).toLowerCase() === '.qoi' &&
        file.startsWith('atlas-')
    );

    log(`Found ${qoiFiles.length} QOI atlas files to process`);

    qoiFiles.forEach(qoiFile => {
        const qoiPath = path.join(targetDir, qoiFile);
        const base64Data = imageToBase64(qoiPath);
        const idString = generateIDString(qoiFile, '.qoi');
        const jsFileName = qoiFile.replace('.qoi', `${qoiSuffix}.js`);
        const jsFilePath = path.join(targetDir, jsFileName);

        const jsContent = generateJSContent(idString, base64Data, 'qoi', qoiFile);

        fs.writeFileSync(jsFilePath, jsContent);
        log(`Processed QOI: ${qoiFile} -> ${jsFileName}`);

        totalProcessed++;
    });
}

if (totalProcessed === 0) {
    log('No atlas image files found to process');
} else {
    log(`Successfully converted ${totalProcessed} image files to JS format.`);
}
