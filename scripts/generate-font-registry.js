#!/usr/bin/env node

/**
 * Generate Font Registry Script
 *
 * This script scans the font-assets directory for metrics files and generates
 * a font-registry.js file containing all available font IDs for use by test-renderer.html.
 *
 * Usage:
 *   node scripts/generate-font-registry.js [options]
 *   npm run generate-registry
 *
 * Options:
 *   --help, -h    Show help message
 *   --verbose, -v Verbose output
 *
 * The script will:
 * 1. Scan font-assets/ for metrics-*.js files
 * 2. Extract font IDs from filenames
 * 3. Generate font-registry.js with FontManifest.addFontIDs() call
 * 4. Save to font-assets/font-registry.js
 */

const fs = require('fs');
const path = require('path');

// Parse command line arguments
const args = process.argv.slice(2);
const isVerbose = args.includes('--verbose') || args.includes('-v');
const showHelp = args.includes('--help') || args.includes('-h');

function log(message) {
  console.log(message);
}

function logVerbose(message) {
  if (isVerbose) {
    console.log(`[VERBOSE] ${message}`);
  }
}

function showHelpMessage() {
  console.log(`
Generate Font Registry Script

This script scans the font-assets directory for metrics files and generates
a font-registry.js file for use by test-renderer.html.

Usage:
  node scripts/generate-font-registry.js [options]
  npm run generate-registry

Options:
  --help, -h     Show this help message
  --verbose, -v  Show verbose output

Examples:
  node scripts/generate-font-registry.js
  node scripts/generate-font-registry.js --verbose
  npm run generate-registry

The script will scan font-assets/ for files matching the pattern:
  metrics-{fontID}.js

And generate font-registry.js containing:
  FontManifest.addFontIDs([...fontIDs])
`);
}

function generateFontRegistry() {
  logVerbose('Starting font registry generation...');

  // Determine paths
  const scriptDir = __dirname;
  const projectDir = path.join(scriptDir, '..');
  const fontAssetsDir = path.join(projectDir, 'font-assets');

  logVerbose(`Project directory: ${projectDir}`);
  logVerbose(`Font assets directory: ${fontAssetsDir}`);

  // Check if font-assets directory exists
  if (!fs.existsSync(fontAssetsDir)) {
    console.error('‚ùå Error: font-assets directory not found');
    console.error(`   Expected location: ${fontAssetsDir}`);
    console.error('   Make sure you are running this script from the project root or that font assets exist.');
    process.exit(1);
  }

  logVerbose('Font assets directory found');

  // Read all files in font-assets
  let files;
  try {
    files = fs.readdirSync(fontAssetsDir);
    logVerbose(`Found ${files.length} files in font-assets directory`);
  } catch (error) {
    console.error(`‚ùå Error reading font-assets directory: ${error.message}`);
    process.exit(1);
  }

  // Filter for metrics-*.js files and extract IDs
  // Exclude "*-full.js" files (non-minified metrics for debugging only, incompatible with runtime)
  const metricsFiles = files.filter(file =>
    file.startsWith('metrics-') &&
    file.endsWith('.js') &&
    !file.endsWith('-full.js')
  );
  logVerbose(`Found ${metricsFiles.length} metrics files`);

  if (isVerbose && metricsFiles.length > 0) {
    console.log('   Metrics files found:');
    metricsFiles.forEach(file => console.log(`     - ${file}`));
  }

  const fontIDs = metricsFiles
    .map(file => {
      // Extract ID: remove 'metrics-' prefix and '.js' suffix
      const id = file.substring(8, file.length - 3);
      logVerbose(`Extracted ID: ${id} from ${file}`);
      return id;
    })
    .sort(); // Sort for consistent output

  if (fontIDs.length === 0) {
    console.warn('‚ö†Ô∏è  Warning: No metrics files found in font-assets/');
    console.warn('   Looking for files matching pattern: metrics-*.js');
    console.warn('   No font-registry.js will be generated');

    if (files.length > 0) {
      console.warn('   Files found in font-assets/:');
      files.forEach(file => console.warn(`     - ${file}`));
    }

    return;
  }

  logVerbose(`Extracted ${fontIDs.length} font IDs (sorted)`);
  if (isVerbose) {
    console.log('   Font IDs:');
    fontIDs.forEach(id => console.log(`     - ${id}`));
  }

  // Generate registry content
  const timestamp = new Date().toISOString();
  const registryContent = `// Auto-generated font registry
// Generated: ${timestamp}
// Source: metrics files in font-assets/
// Font count: ${fontIDs.length}
//
// This file is generated by scripts/generate-font-registry.js
// Do not edit manually - regenerate when font assets change
if (typeof FontManifest !== 'undefined') {
  FontManifest.addFontIDs(${JSON.stringify(fontIDs, null, 2)});
} else {
  console.warn('FontManifest is not available. Make sure FontManifest.js is loaded before this file.');
}`;

  // Write to font-registry.js
  const outputPath = path.join(fontAssetsDir, 'font-registry.js');

  try {
    fs.writeFileSync(outputPath, registryContent, 'utf8');
    logVerbose(`Successfully wrote to: ${outputPath}`);
  } catch (error) {
    console.error(`‚ùå Error writing font-registry.js: ${error.message}`);
    process.exit(1);
  }

  // Success message
  log(`‚úÖ Generated font-registry.js with ${fontIDs.length} font ID${fontIDs.length === 1 ? '' : 's'}`);
  log(`   Location: ${outputPath}`);
  log(`   Font IDs: ${fontIDs.join(', ')}`);

  // Additional guidance
  if (!isVerbose && fontIDs.length > 5) {
    log(`   Use --verbose to see all font IDs`);
  }

  log(`\nüí° Usage: Include font-registry.js in test-renderer.html to load all available fonts`);
}

// Show help if requested
if (showHelp) {
  showHelpMessage();
  process.exit(0);
}

// Run the generator if executed directly
if (require.main === module) {
  try {
    generateFontRegistry();
  } catch (error) {
    console.error(`‚ùå Unexpected error: ${error.message}`);
    if (isVerbose) {
      console.error(error.stack);
    }
    process.exit(1);
  }
}

// Export for programmatic use
module.exports = generateFontRegistry;