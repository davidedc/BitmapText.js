#!/bin/bash

# Build script for Node.js performance benchmarks
# Builds both unbundled and bundled versions

set -e  # Exit on any error

echo "[$(date '+%Y-%m-%d %H:%M:%S')] Building Performance Benchmarks..."

# Project root directory
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_ROOT="$(cd "$SCRIPT_DIR/.." && pwd)"

# Define paths
SRC_DIR="$PROJECT_ROOT/src"
LIB_DIR="$PROJECT_ROOT/lib"
OUTPUT_DIR="$PROJECT_ROOT/perf/node/dist"
UNBUNDLED_OUTPUT="$OUTPUT_DIR/rendering-benchmark-unbundled.bundle.js"
BUNDLED_OUTPUT="$OUTPUT_DIR/rendering-benchmark-bundled.js"

echo "[$(date '+%Y-%m-%d %H:%M:%S')] Project root: $PROJECT_ROOT"

# Create output directory if it doesn't exist
mkdir -p "$OUTPUT_DIR"

# ============================================================================
# BUILD UNBUNDLED VERSION (Standalone)
# ============================================================================

echo "[$(date '+%Y-%m-%d %H:%M:%S')] Building UNBUNDLED version..."

# Verify all source files exist
FILES_TO_CHECK=(
  "$SRC_DIR/platform/canvas-mock.js"
  "$SRC_DIR/runtime/StatusCode.js"
  "$SRC_DIR/runtime/FontProperties.js"
  "$SRC_DIR/runtime/TextProperties.js"
  "$SRC_DIR/runtime/FontMetrics.js"
  "$SRC_DIR/runtime/InterpolatedFontMetrics.js"
  "$SRC_DIR/builder/MetricsExpander.js"
  "$SRC_DIR/runtime/AtlasPositioning.js"
  "$SRC_DIR/runtime/AtlasImage.js"
  "$SRC_DIR/runtime/AtlasData.js"
  "$SRC_DIR/builder/AtlasReconstructionUtils.js"
  "$SRC_DIR/utils/AtlasCellDimensions.js"
  "$SRC_DIR/runtime/TightAtlasReconstructor.js"
  "$LIB_DIR/QOIDecode.js"
  "$SRC_DIR/runtime/AtlasDataStore.js"
  "$SRC_DIR/runtime/FontMetricsStore.js"
  "$SRC_DIR/runtime/FontLoaderBase.js"
  "$SRC_DIR/platform/FontLoader-node.js"
  "$LIB_DIR/PngEncodingOptions.js"
  "$LIB_DIR/PngEncoder.js"
  "$SRC_DIR/runtime/BitmapText.js"
  "$SRC_DIR/shared/test-data.js"
  "$SRC_DIR/node/rendering-benchmark-main.js"
)

for file in "${FILES_TO_CHECK[@]}"; do
  if [[ ! -f "$file" ]]; then
    echo "ERROR: Required source file not found: $file"
    exit 1
  fi
done
echo "[$(date '+%Y-%m-%d %H:%M:%S')] All source files found ✓"

# Start building the unbundled output file
cat > "$UNBUNDLED_OUTPUT" << 'EOF'
#!/usr/bin/env node

/**
 * ⚠️  THIS IS A BUNDLED/BUILT FILE - DO NOT EDIT ⚠️
 *
 * BitmapText.js Performance Benchmark - Unbundled Version
 *
 * This file is automatically generated by concatenating multiple source files.
 * Tests rendering performance with all source files concatenated.
 *
 * Usage:
 *   node perf/node/dist/rendering-benchmark-unbundled.bundle.js
 *
 * Output:
 *   JSON results to stdout
 *
 * Generated by: scripts/build-rendering-benchmark.sh
 */

// ============================================================================
EOF

# Concatenate all files (same order as build-node-demo.sh)
echo "// MINIMAL CANVAS MOCK" >> "$UNBUNDLED_OUTPUT"
echo "// ============================================================================" >> "$UNBUNDLED_OUTPUT"
tail -n +2 "$SRC_DIR/platform/canvas-mock.js" >> "$UNBUNDLED_OUTPUT"
echo "" >> "$UNBUNDLED_OUTPUT"

echo "// ============================================================================" >> "$UNBUNDLED_OUTPUT"
echo "// STATUS CODE CONSTANTS" >> "$UNBUNDLED_OUTPUT"
echo "// ============================================================================" >> "$UNBUNDLED_OUTPUT"
cat "$SRC_DIR/runtime/StatusCode.js" >> "$UNBUNDLED_OUTPUT"
echo "" >> "$UNBUNDLED_OUTPUT"

echo "// ============================================================================" >> "$UNBUNDLED_OUTPUT"
echo "// FONT PROPERTIES CLASS" >> "$UNBUNDLED_OUTPUT"
echo "// ============================================================================" >> "$UNBUNDLED_OUTPUT"
cat "$SRC_DIR/runtime/FontProperties.js" >> "$UNBUNDLED_OUTPUT"
echo "" >> "$UNBUNDLED_OUTPUT"

echo "// ============================================================================" >> "$UNBUNDLED_OUTPUT"
echo "// TEXT PROPERTIES CLASS" >> "$UNBUNDLED_OUTPUT"
echo "// ============================================================================" >> "$UNBUNDLED_OUTPUT"
cat "$SRC_DIR/runtime/TextProperties.js" >> "$UNBUNDLED_OUTPUT"
echo "" >> "$UNBUNDLED_OUTPUT"

echo "// ============================================================================" >> "$UNBUNDLED_OUTPUT"
echo "// FONT METRICS CLASS" >> "$UNBUNDLED_OUTPUT"
echo "// ============================================================================" >> "$UNBUNDLED_OUTPUT"
cat "$SRC_DIR/runtime/FontMetrics.js" >> "$UNBUNDLED_OUTPUT"
echo "" >> "$UNBUNDLED_OUTPUT"

echo "// ============================================================================" >> "$UNBUNDLED_OUTPUT"
echo "// INTERPOLATED FONT METRICS CLASS" >> "$UNBUNDLED_OUTPUT"
echo "// ============================================================================" >> "$UNBUNDLED_OUTPUT"
cat "$SRC_DIR/runtime/InterpolatedFontMetrics.js" >> "$UNBUNDLED_OUTPUT"
echo "" >> "$UNBUNDLED_OUTPUT"

echo "// ============================================================================" >> "$UNBUNDLED_OUTPUT"
echo "// BITMAP TEXT STATIC CLASS" >> "$UNBUNDLED_OUTPUT"
echo "// ============================================================================" >> "$UNBUNDLED_OUTPUT"
cat "$SRC_DIR/runtime/BitmapText.js" >> "$UNBUNDLED_OUTPUT"
echo "" >> "$UNBUNDLED_OUTPUT"

echo "// ============================================================================" >> "$UNBUNDLED_OUTPUT"
echo "// METRICS EXPANDER" >> "$UNBUNDLED_OUTPUT"
echo "// ============================================================================" >> "$UNBUNDLED_OUTPUT"
cat "$SRC_DIR/builder/MetricsExpander.js" >> "$UNBUNDLED_OUTPUT"
echo "" >> "$UNBUNDLED_OUTPUT"

echo "// ============================================================================" >> "$UNBUNDLED_OUTPUT"
echo "// ATLAS POSITIONING CLASS" >> "$UNBUNDLED_OUTPUT"
echo "// ============================================================================" >> "$UNBUNDLED_OUTPUT"
cat "$SRC_DIR/runtime/AtlasPositioning.js" >> "$UNBUNDLED_OUTPUT"
echo "" >> "$UNBUNDLED_OUTPUT"

echo "// ============================================================================" >> "$UNBUNDLED_OUTPUT"
echo "// ATLAS IMAGE CLASS" >> "$UNBUNDLED_OUTPUT"
echo "// ============================================================================" >> "$UNBUNDLED_OUTPUT"
cat "$SRC_DIR/runtime/AtlasImage.js" >> "$UNBUNDLED_OUTPUT"
echo "" >> "$UNBUNDLED_OUTPUT"

echo "// ============================================================================" >> "$UNBUNDLED_OUTPUT"
echo "// ATLAS DATA CLASS" >> "$UNBUNDLED_OUTPUT"
echo "// ============================================================================" >> "$UNBUNDLED_OUTPUT"
cat "$SRC_DIR/runtime/AtlasData.js" >> "$UNBUNDLED_OUTPUT"
echo "" >> "$UNBUNDLED_OUTPUT"

echo "// ============================================================================" >> "$UNBUNDLED_OUTPUT"
echo "// ATLAS RECONSTRUCTION UTILITIES" >> "$UNBUNDLED_OUTPUT"
echo "// ============================================================================" >> "$UNBUNDLED_OUTPUT"
cat "$SRC_DIR/builder/AtlasReconstructionUtils.js" >> "$UNBUNDLED_OUTPUT"
echo "" >> "$UNBUNDLED_OUTPUT"

echo "// ============================================================================" >> "$UNBUNDLED_OUTPUT"
echo "// ATLAS CELL DIMENSIONS" >> "$UNBUNDLED_OUTPUT"
echo "// ============================================================================" >> "$UNBUNDLED_OUTPUT"
cat "$SRC_DIR/utils/AtlasCellDimensions.js" >> "$UNBUNDLED_OUTPUT"
echo "" >> "$UNBUNDLED_OUTPUT"

echo "// ============================================================================" >> "$UNBUNDLED_OUTPUT"
echo "// TIGHT ATLAS RECONSTRUCTOR" >> "$UNBUNDLED_OUTPUT"
echo "// ============================================================================" >> "$UNBUNDLED_OUTPUT"
cat "$SRC_DIR/runtime/TightAtlasReconstructor.js" >> "$UNBUNDLED_OUTPUT"
echo "" >> "$UNBUNDLED_OUTPUT"

echo "// ============================================================================" >> "$UNBUNDLED_OUTPUT"
echo "// QOI DECODER" >> "$UNBUNDLED_OUTPUT"
echo "// ============================================================================" >> "$UNBUNDLED_OUTPUT"
cat "$LIB_DIR/QOIDecode.js" >> "$UNBUNDLED_OUTPUT"
echo "" >> "$UNBUNDLED_OUTPUT"

echo "// ============================================================================" >> "$UNBUNDLED_OUTPUT"
echo "// ATLAS DATA STORE" >> "$UNBUNDLED_OUTPUT"
echo "// ============================================================================" >> "$UNBUNDLED_OUTPUT"
cat "$SRC_DIR/runtime/AtlasDataStore.js" >> "$UNBUNDLED_OUTPUT"
echo "" >> "$UNBUNDLED_OUTPUT"

echo "// ============================================================================" >> "$UNBUNDLED_OUTPUT"
echo "// FONT METRICS STORE" >> "$UNBUNDLED_OUTPUT"
echo "// ============================================================================" >> "$UNBUNDLED_OUTPUT"
cat "$SRC_DIR/runtime/FontMetricsStore.js" >> "$UNBUNDLED_OUTPUT"
echo "" >> "$UNBUNDLED_OUTPUT"

echo "// ============================================================================" >> "$UNBUNDLED_OUTPUT"
echo "// FONT LOADER BASE" >> "$UNBUNDLED_OUTPUT"
echo "// ============================================================================" >> "$UNBUNDLED_OUTPUT"
cat "$SRC_DIR/runtime/FontLoaderBase.js" >> "$UNBUNDLED_OUTPUT"
echo "" >> "$UNBUNDLED_OUTPUT"

echo "// ============================================================================" >> "$UNBUNDLED_OUTPUT"
echo "// FONT LOADER - NODE.JS" >> "$UNBUNDLED_OUTPUT"
echo "// ============================================================================" >> "$UNBUNDLED_OUTPUT"
cat "$SRC_DIR/platform/FontLoader-node.js" >> "$UNBUNDLED_OUTPUT"
echo "" >> "$UNBUNDLED_OUTPUT"

echo "// ============================================================================" >> "$UNBUNDLED_OUTPUT"
echo "// PNG ENCODING OPTIONS" >> "$UNBUNDLED_OUTPUT"
echo "// ============================================================================" >> "$UNBUNDLED_OUTPUT"
cat "$LIB_DIR/PngEncodingOptions.js" >> "$UNBUNDLED_OUTPUT"
echo "" >> "$UNBUNDLED_OUTPUT"

echo "// ============================================================================" >> "$UNBUNDLED_OUTPUT"
echo "// PNG ENCODER" >> "$UNBUNDLED_OUTPUT"
echo "// ============================================================================" >> "$UNBUNDLED_OUTPUT"
cat "$LIB_DIR/PngEncoder.js" >> "$UNBUNDLED_OUTPUT"
echo "" >> "$UNBUNDLED_OUTPUT"

echo "// ============================================================================" >> "$UNBUNDLED_OUTPUT"
echo "// TEST DATA" >> "$UNBUNDLED_OUTPUT"
echo "// ============================================================================" >> "$UNBUNDLED_OUTPUT"
cat "$SRC_DIR/shared/test-data.js" >> "$UNBUNDLED_OUTPUT"
echo "" >> "$UNBUNDLED_OUTPUT"

echo "// ============================================================================" >> "$UNBUNDLED_OUTPUT"
echo "// BENCHMARK LOGIC" >> "$UNBUNDLED_OUTPUT"
echo "// ============================================================================" >> "$UNBUNDLED_OUTPUT"
tail -n +2 "$SRC_DIR/node/rendering-benchmark-main.js" >> "$UNBUNDLED_OUTPUT"

chmod +x "$UNBUNDLED_OUTPUT"

UNBUNDLED_SIZE=$(wc -c < "$UNBUNDLED_OUTPUT" | tr -d ' ')
UNBUNDLED_LINES=$(wc -l < "$UNBUNDLED_OUTPUT" | tr -d ' ')

echo "[$(date '+%Y-%m-%d %H:%M:%S')] Unbundled build completed! ✅"
echo "  Output: $UNBUNDLED_OUTPUT"
echo "  Size: $UNBUNDLED_SIZE bytes"
echo "  Lines: $UNBUNDLED_LINES"
echo ""

# ============================================================================
# BUILD BUNDLED VERSION (Uses Runtime Bundle)
# ============================================================================

echo "[$(date '+%Y-%m-%d %H:%M:%S')] Building BUNDLED version..."

# Start building bundled version
cat > "$BUNDLED_OUTPUT" << 'EOF'
#!/usr/bin/env node

/**
 * ⚠️  THIS IS A BUNDLED/BUILT FILE - DO NOT EDIT ⚠️
 *
 * BitmapText.js Performance Benchmark - Bundled Version
 *
 * This version uses the production runtime bundle.
 *
 * Usage:
 *   node perf/node/dist/rendering-benchmark-bundled.js
 *
 * Output:
 *   JSON results to stdout
 *
 * Generated by: scripts/build-rendering-benchmark.sh
 */

// ============================================================================
// USER-PROVIDED DEPENDENCIES
// ============================================================================

EOF

# Add Canvas mock (without module.exports)
grep -v "module.exports" "$SRC_DIR/platform/canvas-mock.js" >> "$BUNDLED_OUTPUT"
echo "" >> "$BUNDLED_OUTPUT"

# Add PNG encoder dependencies (without module.exports)
grep -v "module.exports" "$LIB_DIR/PngEncodingOptions.js" >> "$BUNDLED_OUTPUT"
echo "" >> "$BUNDLED_OUTPUT"

grep -v "module.exports" "$LIB_DIR/PngEncoder.js" >> "$BUNDLED_OUTPUT"
echo "" >> "$BUNDLED_OUTPUT"

# Add runtime bundle require
echo "// ============================================================================" >> "$BUNDLED_OUTPUT"
echo "// LIBRARY RUNTIME BUNDLE" >> "$BUNDLED_OUTPUT"
echo "// ============================================================================" >> "$BUNDLED_OUTPUT"
echo "" >> "$BUNDLED_OUTPUT"
echo "require('../../../dist/bitmaptext-node.min.js');" >> "$BUNDLED_OUTPUT"
echo "" >> "$BUNDLED_OUTPUT"

# Add Node.js built-ins
echo "// ============================================================================" >> "$BUNDLED_OUTPUT"
echo "// NODE.JS BUILT-IN MODULES" >> "$BUNDLED_OUTPUT"
echo "// ============================================================================" >> "$BUNDLED_OUTPUT"
echo "" >> "$BUNDLED_OUTPUT"
echo "const fs = require('fs');" >> "$BUNDLED_OUTPUT"
echo "const path = require('path');" >> "$BUNDLED_OUTPUT"
echo "" >> "$BUNDLED_OUTPUT"

# Add test data
echo "// ============================================================================" >> "$BUNDLED_OUTPUT"
echo "// TEST DATA" >> "$BUNDLED_OUTPUT"
echo "// ============================================================================" >> "$BUNDLED_OUTPUT"
cat "$SRC_DIR/shared/test-data.js" >> "$BUNDLED_OUTPUT"
echo "" >> "$BUNDLED_OUTPUT"

# Add benchmark logic (skip header, remove require statements)
echo "// ============================================================================" >> "$BUNDLED_OUTPUT"
echo "// BENCHMARK LOGIC" >> "$BUNDLED_OUTPUT"
echo "// ============================================================================" >> "$BUNDLED_OUTPUT"
echo "" >> "$BUNDLED_OUTPUT"
tail -n +23 "$SRC_DIR/node/rendering-benchmark-bundled-main.js" | \
  grep -v "const { Canvas }" | \
  grep -v "const { PngEncoder }" | \
  grep -v "const { PngEncodingOptions }" | \
  grep -v "require('.*bitmaptext-node" | \
  grep -v "const fs = require" | \
  grep -v "const path = require" | \
  grep -v "^// ======" >> "$BUNDLED_OUTPUT"

chmod +x "$BUNDLED_OUTPUT"

BUNDLED_SIZE=$(wc -c < "$BUNDLED_OUTPUT" | tr -d ' ')
BUNDLED_LINES=$(wc -l < "$BUNDLED_OUTPUT" | tr -d ' ')

echo "[$(date '+%Y-%m-%d %H:%M:%S')] Bundled build completed! ✅"
echo "  Output: $BUNDLED_OUTPUT"
echo "  Size: $BUNDLED_SIZE bytes"
echo "  Lines: $BUNDLED_LINES"
echo ""

# ============================================================================
# SUMMARY
# ============================================================================

echo "[$(date '+%Y-%m-%d %H:%M:%S')] All benchmarks built successfully! ✅"
echo ""
echo "Output files:"
echo "  Unbundled: $UNBUNDLED_OUTPUT ($UNBUNDLED_SIZE bytes)"
echo "  Bundled:   $BUNDLED_OUTPUT ($BUNDLED_SIZE bytes)"
echo ""
echo "To run:"
echo "  node $UNBUNDLED_OUTPUT"
echo "  node $BUNDLED_OUTPUT"
echo ""
echo "Or use the runner script:"
echo "  ./perf/node/run-rendering-benchmarks.sh"
