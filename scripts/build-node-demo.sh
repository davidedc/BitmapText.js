#!/bin/bash

# Build script for Node.js hello-world-node.js demo
# Concatenates existing source files to build the standalone demo

set -e  # Exit on any error

echo "[$(date '+%Y-%m-%d %H:%M:%S')] Building Node.js hello-world demo..."

# Project root directory
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_ROOT="$(cd "$SCRIPT_DIR/.." && pwd)"

# Define paths
SRC_DIR="$PROJECT_ROOT/src"
LIB_DIR="$PROJECT_ROOT/lib"
OUTPUT_DIR="$PROJECT_ROOT/examples/node"
OUTPUT_FILE="$OUTPUT_DIR/hello-world-node.js"

echo "[$(date '+%Y-%m-%d %H:%M:%S')] Project root: $PROJECT_ROOT"
echo "[$(date '+%Y-%m-%d %H:%M:%S')] Output file: $OUTPUT_FILE"

# Create output directory if it doesn't exist
mkdir -p "$OUTPUT_DIR"

# Verify all source files exist
FILES_TO_CHECK=(
  "$SRC_DIR/node/canvas-mock.js"
  "$SRC_DIR/utils/nested-properties.js"
  "$SRC_DIR/minification/MetricsExpander.js"
  "$LIB_DIR/QOIDecode.js"
  "$LIB_DIR/PngEncodingOptions.js"
  "$LIB_DIR/PngEncoder.js"
  "$SRC_DIR/core/BitmapGlyphStore.js"
  "$SRC_DIR/core/BitmapText.js"
  "$SRC_DIR/node/hello-world-main.js"
)

echo "[$(date '+%Y-%m-%d %H:%M:%S')] Checking source files..."
for file in "${FILES_TO_CHECK[@]}"; do
  if [[ ! -f "$file" ]]; then
    echo "ERROR: Required source file not found: $file"
    exit 1
  fi
done
echo "[$(date '+%Y-%m-%d %H:%M:%S')] All source files found ✓"

# Start building the output file
echo "[$(date '+%Y-%m-%d %H:%M:%S')] Concatenating files..."

cat > "$OUTPUT_FILE" << 'EOF'
#!/usr/bin/env node

/**
 * BitmapText.js Node.js Demo
 * 
 * Renders "Hello World" using bitmap fonts, loads QOI glyph sheet,
 * and exports as uncompressed PNG. Single file with all dependencies.
 * 
 * Usage:
 *   node examples/node/hello-world-node.js
 * 
 * Output:
 *   hello-world-output.png (in current directory)
 * 
 * This file is automatically generated by scripts/build-node-demo.sh
 * Do not edit directly - edit source files instead and rebuild.
 */

// ============================================================================
EOF

# Concatenate Canvas mock
echo "// MINIMAL CANVAS MOCK - Only what BitmapText.js needs" >> "$OUTPUT_FILE"
echo "// ============================================================================" >> "$OUTPUT_FILE"
echo "" >> "$OUTPUT_FILE"
tail -n +2 "$SRC_DIR/node/canvas-mock.js" >> "$OUTPUT_FILE"
echo "" >> "$OUTPUT_FILE"

# Concatenate utility functions
echo "// ============================================================================" >> "$OUTPUT_FILE"
echo "// UTILITY FUNCTIONS - nested-properties.js" >> "$OUTPUT_FILE"
echo "// ============================================================================" >> "$OUTPUT_FILE"
echo "" >> "$OUTPUT_FILE"
cat "$SRC_DIR/utils/nested-properties.js" >> "$OUTPUT_FILE"
echo "" >> "$OUTPUT_FILE"

# Concatenate expansion utility
echo "// ============================================================================" >> "$OUTPUT_FILE"
echo "// EXPANSION UTILITY - MetricsExpander.js" >> "$OUTPUT_FILE"
echo "// ============================================================================" >> "$OUTPUT_FILE"
echo "" >> "$OUTPUT_FILE"
cat "$SRC_DIR/minification/MetricsExpander.js" >> "$OUTPUT_FILE"
echo "" >> "$OUTPUT_FILE"

# Concatenate QOI decoder
echo "// ============================================================================" >> "$OUTPUT_FILE"
echo "// QOI DECODER LIBRARY" >> "$OUTPUT_FILE"
echo "// ============================================================================" >> "$OUTPUT_FILE"
echo "" >> "$OUTPUT_FILE"
cat "$LIB_DIR/QOIDecode.js" >> "$OUTPUT_FILE"
echo "" >> "$OUTPUT_FILE"

# Concatenate PNG encoding options
echo "// ============================================================================" >> "$OUTPUT_FILE"
echo "// PNG ENCODING OPTIONS" >> "$OUTPUT_FILE"
echo "// ============================================================================" >> "$OUTPUT_FILE"
echo "" >> "$OUTPUT_FILE"
cat "$LIB_DIR/PngEncodingOptions.js" >> "$OUTPUT_FILE"
echo "" >> "$OUTPUT_FILE"

# Concatenate PNG encoder
echo "// ============================================================================" >> "$OUTPUT_FILE"
echo "// PNG ENCODER" >> "$OUTPUT_FILE"
echo "// ============================================================================" >> "$OUTPUT_FILE"
echo "" >> "$OUTPUT_FILE"
cat "$LIB_DIR/PngEncoder.js" >> "$OUTPUT_FILE"
echo "" >> "$OUTPUT_FILE"

# Concatenate BitmapGlyphStore
echo "// ============================================================================" >> "$OUTPUT_FILE"
echo "// BITMAP GLYPH STORE" >> "$OUTPUT_FILE"
echo "// ============================================================================" >> "$OUTPUT_FILE"
echo "" >> "$OUTPUT_FILE"
cat "$SRC_DIR/core/BitmapGlyphStore.js" >> "$OUTPUT_FILE"
echo "" >> "$OUTPUT_FILE"

# Concatenate BitmapText
echo "// ============================================================================" >> "$OUTPUT_FILE"
echo "// BITMAP TEXT RENDERER" >> "$OUTPUT_FILE"
echo "// ============================================================================" >> "$OUTPUT_FILE"
echo "" >> "$OUTPUT_FILE"
cat "$SRC_DIR/core/BitmapText.js" >> "$OUTPUT_FILE"
echo "" >> "$OUTPUT_FILE"

# Concatenate main execution
echo "// ============================================================================" >> "$OUTPUT_FILE"
echo "// MAIN EXECUTION - Node.js Hello World Demo" >> "$OUTPUT_FILE"
echo "// ============================================================================" >> "$OUTPUT_FILE"
echo "" >> "$OUTPUT_FILE"
tail -n +2 "$SRC_DIR/node/hello-world-main.js" >> "$OUTPUT_FILE"

# Make the output file executable
chmod +x "$OUTPUT_FILE"

# Calculate file stats
FILE_SIZE=$(wc -c < "$OUTPUT_FILE" | tr -d ' ')
LINE_COUNT=$(wc -l < "$OUTPUT_FILE" | tr -d ' ')

echo "[$(date '+%Y-%m-%d %H:%M:%S')] Build completed successfully! ✅"
echo ""
echo "Output: $OUTPUT_FILE"
echo "Size: $FILE_SIZE bytes"
echo "Lines: $LINE_COUNT"
echo ""
echo "To run the demo:"
echo "  cd $PROJECT_ROOT"
echo "  node examples/node/hello-world-node.js"
echo ""
echo "To rebuild:"
echo "  ./scripts/build-node-demo.sh"