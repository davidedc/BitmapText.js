<!DOCTYPE html>
<html lang="">

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Uniform Pixel Perfect JS Canvas Text Renderer</title>
  <style>
    body {
      padding: 0;
      margin: 0;
      background-color: #d4ffd4;
    }
    canvas {
      font-smooth: never;
      -webkit-font-smoothing: none;
      -moz-osx-font-smoothing: none;
      /* 1 pixel border around canvas */
      /* border: 1px solid #000; */
      margin-left: 3px;
    }
  </style>
</head>

<body>
  <main>
    <div id="selectors"></div>
    <div id="testCopyCanvases" style="clear:both;"></div>

    <!-- ATLAS GENERATION & RECONSTRUCTION SECTION -->
    <div id="atlas-section" style="margin-top: 40px; border-top: 3px solid #333; padding-top: 20px;">
      <h2>üî¨ Atlas Generation & Reconstruction</h2>
      <p style="font-size: 14px; color: #666; margin: 5px 0;">
        Atlases are generated automatically when you change font settings above. You can also click the button to regenerate manually.
      </p>

      <button onclick="runAtlasGenerationAndDisplay()" style="font-size: 16px; padding: 10px 20px; margin: 10px 0;">
        Regenerate Atlases
      </button>

      <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-top: 20px;">
        <!-- Column 1: Atlas Source (Variable-width cells) -->
        <div>
          <h3>Atlas Source (Variable-Width Cells)</h3>
          <canvas id="atlas-source" style="border: 1px solid #ccc; image-rendering: pixelated;"></canvas>
          <div id="atlas-source-info" style="font-family: monospace; font-size: 12px;"></div>
        </div>

        <!-- Column 2: Tight Atlas (Reconstructed) -->
        <div>
          <h3>Tight Atlas (Reconstructed)</h3>
          <canvas id="tight-atlas-reconstructed" style="border: 1px solid #ccc; image-rendering: pixelated;"></canvas>
          <div id="tight-atlas-reconstructed-info" style="font-family: monospace; font-size: 12px;"></div>
          <canvas id="reconstructed-render" style="border: 1px solid #ccc; margin-top: 10px;"></canvas>
        </div>
      </div>

      <!-- Atlas Information -->
      <div id="atlas-info-display" style="margin-top: 20px; padding: 20px; background: #e8f5e9; border-radius: 5px;">
        <h3>üìä Atlas Information</h3>
        <div id="atlas-details" style="font-family: monospace; font-size: 13px; line-height: 1.8;"></div>
      </div>
    </div>
  </main>
</body>

<script src="../lib/jszip.min.js"></script>
<script src="../lib/FileSaver.min.js"></script>
<script src="../lib/QOIEncode.js"></script>

<script src="../src/utils/timing.js"></script>

<script >
  const maxFontSize_px = 80;
  const fontSizeIncrement_px = 0.5;
  let specsDefault;
  function updatePageContent() {
    buildAndShowGlyphs();
    // Also run atlas generation to keep it in sync with UI
    // Check if function exists (it's defined later in the page)
    if (typeof runAtlasGenerationAndDisplay === 'function') {
      runAtlasGenerationAndDisplay();
    }
  }
</script>

<script src="../src/runtime/StatusCode.js"></script>
<script src="../src/runtime/FontProperties.js"></script>
<script src="../src/runtime/TextProperties.js"></script>
<script src="../src/builder/FontPropertiesFAB.js"></script>
<script src="../src/runtime/FontMetrics.js"></script>
<script src="../src/builder/FontMetricsFAB.js"></script>
<script src="../src/runtime/AtlasPositioning.js"></script>
<script src="../src/builder/AtlasPositioningFAB.js"></script>
<script src="../src/runtime/AtlasImage.js"></script>
<script src="../src/runtime/AtlasData.js"></script>
<script src="../src/builder/AtlasReconstructionUtils.js"></script>
<!-- Atlas generation utilities -->
<script src="../src/utils/AtlasCellDimensions.js"></script>
<script src="../src/builder/AtlasBuilder.js"></script>
<script src="../src/runtime/TightAtlasReconstructor.js"></script>
<script src="../src/utils/HashStore.js"></script>
<script src="../test/data/reference-hashes.js"></script>
<script src="../src/utils/canvas-extensions.js"></script>
<script src="../src/builder/GlyphFAB.js"></script>
<script src="../src/runtime/AtlasDataStore.js"></script>
<script src="../src/runtime/FontMetricsStore.js"></script>
<script src="../src/builder/AtlasImageFAB.js"></script>
<script src="../src/builder/AtlasDataStoreFAB.js"></script>
<script src="../src/builder/FontMetricsStoreFAB.js"></script>
<script src="../src/runtime/FontLoaderBase.js"></script>
<script src="../src/platform/FontLoader-browser.js"></script>
<script src="../src/runtime/BitmapText.js"></script>
<script src="../src/specs/Specs.js"></script>
<script src="../src/builder/KerningCalculator.js"></script>
<script src="../src/builder/BitmapTextFAB.js"></script>
<script src="../src/specs/SpecsParser.js"></script>
<script src="../src/specs/default-specs.js"></script>
<script src="../test/utils/test-copy.js"></script>
<script src="../test/utils/draw-test-text.js"></script>
<script src="../src/utils/dom-cleanup.js"></script>
<script src="../test/utils/show-glyphs.js"></script>
<script src="../test/utils/build-show-glyphs.js"></script>
<script src="../test/utils/create-glyphs.js"></script>
<script src="../src/ui/components/copy-choice.js"></script>
<script src="../src/ui/components/pixel-density.js"></script>
<script src="../src/ui/components/font-family-dropdown.js"></script>
<script src="../src/ui/components/font-style-dropdown.js"></script>
<script src="../src/ui/components/font-weight-dropdown.js"></script>
<script src="../src/ui/components/size-buttons.js"></script>
<script src="../src/ui/base-ui.js"></script>
<script src="../src/ui/font-assets-builder-ui.js"></script>
<script src="../tools/export-font-data.js"></script>
<script src="../src/builder/MetricsMinifier.js"></script>
<!-- needed to test the roundtrip minification + expansion works -->
<script src="../src/builder/MetricsExpander.js"></script>
<script src="../src/utils/deep-equal.js"></script>

<script >
  // All stores and BitmapTextFAB are now static classes - no instance creation needed

  updatePageContent();
</script>

<!-- ATLAS GENERATION & RECONSTRUCTION JAVASCRIPT -->
<script>
  function runAtlasGenerationAndDisplay() {
    const currentFontProperties = getFontPropertiesFromUI();

    console.group(`üî¨ Atlas Generation: ${currentFontProperties.idString}`);
    console.log(`Font: ${currentFontProperties.fontSize}px ${currentFontProperties.fontFamily} ${currentFontProperties.fontStyle} ${currentFontProperties.fontWeight}`);
    console.log(`Pixel Density: ${currentFontProperties.pixelDensity}`);

    try {
      console.time('‚è±Ô∏è Total atlas generation time');

      // Build Atlas (variable-width cells)
      console.time('  ‚îú‚îÄ Atlas build');
      const atlasResult = AtlasDataStoreFAB.buildAtlas(currentFontProperties);
      console.timeEnd('  ‚îú‚îÄ Atlas build');
      console.log(`  ‚îÇ  Atlas: ${atlasResult.canvas.width}√ó${atlasResult.canvas.height}`);

      // Reconstruct Tight Atlas from Atlas
      console.time('  ‚îî‚îÄ Tight atlas reconstruction');
      const reconstructedAtlasData = AtlasDataStoreFAB.reconstructTightAtlas(
        atlasResult.canvas,
        currentFontProperties
      );
      console.timeEnd('  ‚îî‚îÄ Tight atlas reconstruction');

      const charCount = reconstructedAtlasData.atlasPositioning.getAvailableCharacters().length;
      console.log(`     Tight: ${reconstructedAtlasData.atlasImage.width}√ó${reconstructedAtlasData.atlasImage.height}`);
      console.log(`     Characters: ${charCount}`);

      console.timeEnd('‚è±Ô∏è Total atlas generation time');
      console.groupEnd();

      // Display atlases
      displayAtlasCanvas(atlasResult.canvas, 'atlas-source');
      displayAtlasCanvas(reconstructedAtlasData.atlasImage.image, 'tight-atlas-reconstructed');

      // Display info
      displayAtlasInfo(atlasResult.canvas, 'atlas-source-info', currentFontProperties, 'atlas', null);
      displayAtlasInfo(reconstructedAtlasData.atlasImage.image, 'tight-atlas-reconstructed-info',
                       currentFontProperties, 'tight atlas', reconstructedAtlasData.atlasPositioning);

      // Render test text using reconstructed atlas
      const reconstructedRenderCanvas = document.getElementById('reconstructed-render');
      renderTestText(reconstructedRenderCanvas, reconstructedAtlasData, currentFontProperties);

      // Display atlas information
      displayAtlasDetails(atlasResult, reconstructedAtlasData, currentFontProperties);

    } catch (error) {
      console.error('‚ùå Atlas generation error:', error);
      console.groupEnd();
      const detailsDiv = document.getElementById('atlas-details');
      detailsDiv.innerHTML = `<div style="color: #c62828;"><strong>ERROR:</strong> ${error.message}</div><pre style="font-size: 11px;">${error.stack}</pre>`;
    }
  }

  function displayAtlasCanvas(sourceCanvas, targetId) {
    const target = document.getElementById(targetId);
    if (!target) {
      console.warn(`Canvas element with id "${targetId}" not found`);
      return;
    }
    target.width = sourceCanvas.width;
    target.height = sourceCanvas.height;
    const ctx = target.getContext('2d');
    ctx.drawImage(sourceCanvas, 0, 0);
  }

  function displayAtlasInfo(canvas, targetDivId, fontProperties, hashSuffix, atlasPositioning = null) {
    const targetDiv = document.getElementById(targetDivId);
    if (!targetDiv) {
      console.warn(`Div element with id "${targetDivId}" not found`);
      return;
    }
    const ctx = canvas.getContext('2d');
    const hashString = ctx.getHashString();

    // Get hash match info if available
    let additionalInfo = '';
    if (typeof calculateFontPropertiesHashKey === 'function' && typeof hashStore !== 'undefined') {
      const hashKey = calculateFontPropertiesHashKey(fontProperties, hashSuffix);
      const result = hashStore.compareHash(hashKey, hashString);
      additionalInfo = result.message || '';
    }

    // Add positioning hash if available
    let positioningHashInfo = '';
    if (atlasPositioning && typeof atlasPositioning.getHash === 'function') {
      const posHash = atlasPositioning.getHash();
      positioningHashInfo = ` pos: ${posHash}`;
    }

    targetDiv.innerHTML = `${canvas.width} x ${canvas.height} hash: ${hashString}${positioningHashInfo} ${additionalInfo}`;
  }

  function displayAtlasDetails(atlasResult, reconstructedAtlasData, fontProperties) {
    const detailsDiv = document.getElementById('atlas-details');
    if (!detailsDiv) {
      console.warn('Div element with id "atlas-details" not found');
      return;
    }

    const charCount = reconstructedAtlasData.atlasPositioning.getAvailableCharacters().length;
    const atlasSize = atlasResult.canvas.width * atlasResult.canvas.height * 4;
    const atlasSizeKB = (atlasSize / 1024).toFixed(2);
    const tightAtlasSize = reconstructedAtlasData.atlasImage.width * reconstructedAtlasData.atlasImage.height * 4;
    const tightSizeKB = (tightAtlasSize / 1024).toFixed(2);
    const estimatedPngKB = (atlasSize * 0.015 / 1024).toFixed(2);
    const positioningHash = reconstructedAtlasData.atlasPositioning.getHash();

    detailsDiv.innerHTML = `
      <div><strong>Character Count:</strong> ${charCount} glyphs</div>
      <div><strong>Atlas Source Dimensions:</strong> ${atlasResult.canvas.width}√ó${atlasResult.canvas.height} = ${atlasSizeKB} KB uncompressed</div>
      <div><strong>Tight Atlas Dimensions:</strong> ${reconstructedAtlasData.atlasImage.width}√ó${reconstructedAtlasData.atlasImage.height} = ${tightSizeKB} KB uncompressed</div>
      <div><strong>Estimated PNG Size:</strong> ~${estimatedPngKB} KB (1.5% compression estimate)</div>
      <div><strong>Positioning Hash:</strong> ${positioningHash}</div>
      <div style="margin-top: 10px; color: #2e7d32;"><strong>‚úì</strong> Atlas generation and reconstruction completed successfully</div>
    `;
  }

  function renderTestText(canvas, atlasData, fontProperties) {
    if (!canvas) {
      console.warn('Canvas element not found for renderTestText');
      return;
    }
    canvas.width = 1600;
    canvas.height = 200;
    const ctx = canvas.getContext('2d');
    ctx.fillStyle = 'white';
    ctx.fillRect(0, 0, canvas.width, canvas.height);

    // Temporarily store atlas and metrics in static BitmapText for rendering test
    const previousAtlas = BitmapText.getAtlasData(fontProperties);
    const previousMetrics = BitmapText.getFontMetrics(fontProperties);

    BitmapText.setAtlasData(fontProperties, atlasData);

    // Also store metrics from FontMetricsStore (needed for rendering)
    const fontMetrics = FontMetricsStore.getFontMetrics(fontProperties);
    if (fontMetrics) {
      BitmapText.setFontMetrics(fontProperties, fontMetrics);
    }

    const testText = "Hello World!" + " ‚ñàabcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789√ü!\"#$%&‚Ç¨''()*+,-./:;<=>?@[\\]^_`{|}~‚Äî¬£¬∞¬≤¬∑√Ä√á√†√ß‚Ä¢";
    const textProps = new TextProperties();
    BitmapText.drawTextFromAtlas(ctx, testText, 10, 50, fontProperties, textProps);

    // Restore previous atlas and metrics if they existed
    if (previousAtlas) {
      BitmapText.setAtlasData(fontProperties, previousAtlas);
    } else {
      BitmapText.deleteAtlas(fontProperties);
    }
    if (previousMetrics) {
      BitmapText.setFontMetrics(fontProperties, previousMetrics);
    }
    // Note: We don't delete metrics if there were none before - they may be needed elsewhere
  }

  // Run atlas generation on initial page load
  runAtlasGenerationAndDisplay();
</script>


</html>