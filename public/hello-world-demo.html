<!DOCTYPE html>
<html lang="">

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>BitmapText.js - Hello World Demo</title>
  <style>
    body {
      padding: 20px;
      font-family: Arial, sans-serif;
      background-color: #f5f5f5;
    }
    
    h1 {
      margin-bottom: 20px;
      color: #333;
    }
    
    canvas {
      border: 1px solid #ccc;
      background: white;
      margin-top: 10px;
    }
  </style>
</head>

<body>
  <h1>BitmapText.js - Minimal Hello World Demo</h1>
  <p>This demo shows "Hello World" rendered using pre-generated bitmap fonts for pixel-perfect consistency.</p>
  <canvas id="demo-canvas" width="300" height="100"></canvas>

  <!-- Essential dependencies -->
  <!-- Expander utility to unpack minified font metrics data -->
  <script src="../src/minification/MetricsExpander.js"></script>
  <!-- FontProperties class for font configuration -->
  <script src="../src/core/FontProperties.js"></script>
  <!-- Data store for glyph sheets, metrics, and kerning tables -->
  <script src="../src/core/BitmapGlyphStore.js"></script>
  <!-- Main bitmap text rendering engine -->
  <script src="../src/core/BitmapText.js"></script>

  <script>
    // Font properties for Arial normal normal 19 with pixel density 1
    const fontProperties = new FontProperties(1, "Arial", "normal", "normal", 19); // pixelDensity, fontFamily, fontStyle, fontWeight, fontSize

    // Initialize bitmap text system
    const bitmapGlyphStore = new BitmapGlyphStore();
    const bitmapText = new BitmapText(bitmapGlyphStore);

    // Canvas setup
    const canvas = document.getElementById('demo-canvas');
    const ctx = canvas.getContext('2d');

    // Initialize global variables (required by the font JS files)
    window.loadedBitmapFontData = {};
    window.imagesFromJs = {};
    window.isKerningEnabled = true;  // Enable kerning for better text rendering

    // Font data loading tracking
    let loadedFiles = 0;
    const totalFiles = 2; // JS data + image

    function onFileLoaded() {
      loadedFiles++;
      if (loadedFiles === totalFiles) {
        renderHelloWorld();
      }
    }

    // Load font data (JS file with metrics)
    const dataScript = document.createElement('script');
    dataScript.src = '../font-assets/metrics-density-1-0-Arial-style-normal-weight-normal-size-19-0.js';
    dataScript.onload = function() {
      // Process loaded font data
      const IDString = "density-1-0-Arial-style-normal-weight-normal-size-19-0";
      const fontData = window.loadedBitmapFontData[IDString];
      
      // Set up glyph store with loaded data
      bitmapGlyphStore.setKerningTable(fontProperties, fontData.kerningTable);
      bitmapGlyphStore.setGlyphsTextMetrics(fontProperties, fontData.glyphsTextMetrics);
      bitmapGlyphStore.setGlyphSheetMetrics(fontProperties, fontData.glyphSheetsMetrics);
      bitmapGlyphStore.setSpaceAdvancementOverrideForSmallSizesInPx(
        fontProperties, 
        fontData.spaceAdvancementOverrideForSmallSizesInPx
      );

      onFileLoaded();
    };
    document.head.appendChild(dataScript);

    // Load glyph sheet image
    function loadGlyphSheet() {
      if (window.location.href.includes("file://")) {
        // Load from JS-wrapped image for file:// protocol
        const imageScript = document.createElement('script');
        imageScript.src = '../font-assets/atlas-density-1-0-Arial-style-normal-weight-normal-size-19-0.js';
        imageScript.onload = function() {
          const img = new Image();
          img.src = `data:image/png;base64,${window.imagesFromJs["density-1-0-Arial-style-normal-weight-normal-size-19-0"]}`;
          img.onload = function() {
            bitmapGlyphStore.setGlyphSheet(fontProperties, img);
            onFileLoaded();
          };
        };
        document.head.appendChild(imageScript);
      } else {
        // Load PNG directly for http:// protocol
        const img = new Image();
        img.src = '../font-assets/atlas-density-1-0-Arial-style-normal-weight-normal-size-19-0.png';
        img.onload = function() {
          bitmapGlyphStore.setGlyphSheet(fontProperties, img);
          onFileLoaded();
        };
      }
    }

    loadGlyphSheet();

    function renderHelloWorld() {
      // Clear canvas with white background
      ctx.fillStyle = 'white';
      ctx.fillRect(0, 0, canvas.width, canvas.height);

      // Draw "Hello World" using bitmap text
      bitmapText.drawTextFromGlyphSheet(
        ctx, 
        "Hello World", 
        10,  // x position
        50,  // y position
        fontProperties, 
        '#000000'  // black color
      );

      console.log('Hello World rendered successfully!');
    }
  </script>
</body>

</html>