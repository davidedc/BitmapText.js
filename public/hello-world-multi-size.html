<!DOCTYPE html>
<html lang="">

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>BitmapText.js - Hello World Multi-Size Demo</title>
  <style>
    body {
      padding: 20px;
      font-family: Arial, sans-serif;
      background-color: #f5f5f5;
    }
    
    h1 {
      margin-bottom: 20px;
      color: #333;
    }
    
    canvas {
      border: 1px solid #ccc;
      background: white;
      margin-top: 10px;
    }
    
    .info {
      margin-top: 15px;
      padding: 10px;
      background: #e8f4f8;
      border-radius: 5px;
      font-size: 14px;
      color: #555;
    }
  </style>
</head>

<body>
  <h1>BitmapText.js - Hello World Multi-Size Demo</h1>
  <p>This demo shows "Hello World" rendered at three different font sizes (18, 18.5, 19) to demonstrate what's required for multi-size bitmap text rendering.</p>
  <canvas id="demo-canvas" width="400" height="200"></canvas>

  <div class="info">
    <strong>Key Learning:</strong> Each font size requires its own pre-generated bitmap font data.
    This demo loads 6 files total (3 JS metrics files + 3 atlas images).
  </div>

  <!-- Essential dependencies -->
  <!-- Expander utility to unpack minified font metrics data -->
  <script src="../src/minification/MetricsExpander.js"></script>
  <!-- Font loading utilities -->
  <script src="../src/utils/font-loader-config.js"></script>
  <script src="../src/utils/font-loader.js"></script>
  <!-- FontProperties class for font configuration -->
  <script src="../src/core/FontProperties.js"></script>
  <!-- Data store for atlases, metrics, and kerning tables -->
  <script src="../src/core/AtlasStore.js"></script>
  <!-- Main bitmap text rendering engine -->
  <script src="../src/core/BitmapText.js"></script>

  <script>
    // Font properties for each size - Arial normal normal with pixel density 1
    const fontSizes = [18, 18.5, 19];
    const fontPropertiesArray = fontSizes.map(size => 
      new FontProperties(1, "Arial", "normal", "normal", size) // pixelDensity, fontFamily, fontStyle, fontWeight, fontSize
    );

    // Initialize bitmap text system
    const atlasStore = new AtlasStore();
    const bitmapText = new BitmapText(atlasStore);

    // Canvas setup
    const canvas = document.getElementById('demo-canvas');
    const ctx = canvas.getContext('2d');

    // Initialize global variables (required by the font JS files)
    window.loadedBitmapFontData = {};
    window.imagesFromJs = {};
    window.isKerningEnabled = true;  // Enable kerning for better text rendering

    // Function to create IDString from font size
    function createIDString(fontSize) {
      // Handle fractional sizes: 18.5 becomes "18-5", whole numbers get "-0" suffix
      const sizeStr = fontSize.toString().replace('.', '-');
      // Add "-0" suffix for whole numbers (18 -> "18-0"), fractional already have second part (18.5 -> "18-5")
      const finalSizeStr = sizeStr.includes('-') ? sizeStr : `${sizeStr}-0`;
      return `density-1-0-Arial-style-normal-weight-normal-size-${finalSizeStr}`;
    }

    // Create IDStrings for all font sizes
    const IDStrings = fontSizes.map(createIDString);
    
    // Use FontLoader to load all font data
    const isFileProtocol = window.location.href.includes("file://");
    const fontLoader = new FontLoader(atlasStore, (loaded, total) => {
      console.log(`Loaded ${loaded} of ${total} files`);
    });

    // Load fonts and handle completion
    fontLoader.loadFonts(IDStrings, isFileProtocol)
      .then(() => {
        // Ingest the loaded bitmap font data (same as in manifest-loader.js)
        for (const IDString of IDStrings) {
          const fontProperties = fontPropertiesArray[IDStrings.indexOf(IDString)];
          const fontData = window.loadedBitmapFontData[IDString];
          
          if (fontData) {
            atlasStore.setKerningTable(fontProperties, fontData.kerningTable);
            atlasStore.setGlyphsTextMetrics(fontProperties, fontData.glyphsTextMetrics);
            atlasStore.setAtlasMetrics(fontProperties, fontData.atlasMetrics);
            atlasStore.setSpaceAdvancementOverrideForSmallSizesInPx(
              fontProperties,
              fontData.spaceAdvancementOverrideForSmallSizesInPx
            );
          }
        }
        
        // Render the multi-size text
        renderMultiSizeHelloWorld();
      });

    function renderMultiSizeHelloWorld() {
      // Clear canvas with white background
      ctx.fillStyle = 'white';
      ctx.fillRect(0, 0, canvas.width, canvas.height);

      // Draw "Hello World" at each font size
      fontPropertiesArray.forEach((fontProperties, index) => {
        const yPosition = 50 + (index * 50); // Space lines 50px apart
        const text = `Hello World (size ${fontProperties.fontSize})`;
        
        bitmapText.drawTextFromAtlas(
          ctx,
          text,
          20,  // x position
          yPosition,
          fontProperties,
          '#000000'  // black color
        );
        
        console.log(`Rendered "${text}" at y=${yPosition}`);
      });

      console.log('Multi-size Hello World rendered successfully!');
    }
  </script>
</body>

</html>