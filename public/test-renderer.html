<!--
You'll need to serve this file from a server to avoid CORS issues, because if you open the page from filesystem
the dynamic loading of the images seems to create security issues when you then try to read the pixels from the canvas
where you painted the images.

So use a simple server like this:
  python -m http.server
and then open the page from the browser at:
  http://localhost:8000/renderer.html
-->

<!DOCTYPE html>
<html lang="">

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Uniform Pixel Perfect JS Canvas Text Renderer</title>
  <style>
    body {
      padding: 0;
      margin: 0;
      background-color: #d4ffd4;
    }
    canvas {
      font-smooth: never;
      -webkit-font-smoothing: none;
      -moz-osx-font-smoothing: none;
      /* 1 pixel border around canvas */
      /* border: 1px solid #000; */
      margin-left: 3px;
    }
  </style>
</head>

<body>
  <main>
    <div id="selectors"></div>
    <div id="testCopyCanvases" style="clear:both;"></div>
  </main>
</body>

<script src="../src/utils/timing.js"></script>

<script >
  const maxFontSize_px = 80;
  const fontSizeIncrement_px = 0.5;
  let bitmapTextManifest;
  let specsDefault;
  function updatePageContent() {
    showGlyphs();
  }
</script>

<script src="../src/core/StatusCode.js"></script>
<script src="../src/core/FontProperties.js"></script>
<script src="../src/core/TextProperties.js"></script>
<script src="../src/core/FontMetrics.js"></script>
<script src="../src/utils/HashStore.js"></script>
<script src="../test/data/reference-hashes.js"></script>
<script src="../src/utils/canvas-extensions.js"></script>
<script src="../src/core/AtlasStore.js"></script>
<script src="../src/core/FontMetricsStore.js"></script>
<script src="../src/core/BitmapText.js"></script>
<script src="../test/utils/test-copy.js"></script>
<script src="../test/utils/draw-test-text.js"></script>
<script src="../src/utils/dom-cleanup.js"></script>
<script src="../test/utils/show-glyphs.js"></script>
<script src="../test/utils/create-glyphs.js"></script>
<script src="../src/ui/components/copy-choice.js"></script>
<script src="../src/ui/components/pixel-density.js"></script>
<script src="../src/ui/components/font-family-dropdown.js"></script>
<script src="../src/ui/components/font-style-dropdown.js"></script>
<script src="../src/ui/components/font-weight-dropdown.js"></script>
<script src="../src/ui/components/size-buttons.js"></script>
<script src="../src/ui/base-ui.js"></script>
<script src="../src/minification/MetricsExpander.js"></script>

<script >
  const atlasStore = new AtlasStore();
  const fontMetricsStore = new FontMetricsStore();
</script>

<!-- TODO pick a more specific name for the manifest, something that suggests that this is for this text rendering system-->
<script src="../font-assets/manifest.js"></script>
<script src="../src/utils/font-loader-config.js"></script>
<script src="../src/utils/font-loader.js"></script>

<script>
  // Ensure everything is loaded before starting
  console.log("FontLoader available:", typeof FontLoader !== 'undefined');
  console.log("Manifest available:", typeof bitmapTextManifest !== 'undefined');

  if (typeof FontLoader === 'undefined') {
    console.error("FontLoader is not defined. Check that font-loader.js loaded properly.");
  } else if (typeof bitmapTextManifest === 'undefined') {
    console.error("bitmapTextManifest is not defined. Check that manifest.js loaded properly.");
  } else {
    // Load all fonts from manifest and trigger test rendering
    startTiming('loadingFontData');

    // Determine protocol for image loading
    const isFileProtocol = window.location.href.includes("file://");

    // Load all fonts using FontLoader
    console.log("Using manifest IDs:", bitmapTextManifest.IDs);

    const fontLoader = new FontLoader(atlasStore, fontMetricsStore, (loaded, total) => {
      console.log(`loadedScripts: ${loaded} out of ${total}`);
    });

    fontLoader.loadFonts(bitmapTextManifest.IDs, isFileProtocol)
      .then(() => {
        console.log("⏱️ loadingFontData took " + stopTiming('loadingFontData') + " milliseconds");
        console.log("All metrics loaded directly to store");

        startTiming('drawTestText');
        const fontProperties = getFontPropertiesFromUI();
        drawTestText_withStandardClass(fontProperties, atlasStore, fontMetricsStore);
        console.log("⏱️ drawTestText took " + stopTiming('drawTestText') + " milliseconds");
      })
      .catch(error => {
        console.error("Font loading failed:", error);
      });
  }
</script>


</html>