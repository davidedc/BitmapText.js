<!DOCTYPE html>
<html lang="">

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>BitmapText.js - Small Text Rendering Demo</title>
  <style>
    body {
      padding: 20px;
      font-family: Arial, sans-serif;
      background-color: #f5f5f5;
    }

    h1 {
      margin-bottom: 20px;
      color: #333;
    }

    .info-box {
      background-color: #e8f4f8;
      border-left: 4px solid #2196F3;
      padding: 15px;
      margin: 20px 0;
    }

    .info-box h3 {
      margin-top: 0;
      color: #1976D2;
    }

    canvas {
      border: 1px solid #ccc;
      background: white;
      margin-top: 10px;
      margin-bottom: 20px;
    }

    .canvas-label {
      font-weight: bold;
      margin-top: 20px;
      color: #555;
    }
  </style>
</head>

<body>
  <h1>BitmapText.js - Small Text Rendering Demo (Sizes &lt; 9px)</h1>

  <div class="info-box">
    <h3>Small Font Size Interpolation</h3>
    <p>Font sizes &lt; 9px use <strong>interpolated metrics</strong> from size 9px and render as <strong>placeholder rectangles</strong>.</p>
    <ul>
      <li>Only <strong>one set of assets</strong> (9px) is needed for all small sizes</li>
      <li>Metrics are scaled down proportionally: <code>size / 9</code></li>
      <li>Atlases are never loaded - placeholder mode is always used</li>
      <li>Text measurements work correctly with scaled metrics</li>
    </ul>
  </div>

  <div class="canvas-label">Sizes 0px through 9px:</div>
  <canvas id="small-sizes-canvas" width="1000" height="520"></canvas>

  <div class="canvas-label">Measurements for All Sizes:</div>
  <canvas id="measurement-canvas" width="1000" height="550"></canvas>

  <!-- Essential dependencies -->
  <script src="../src/runtime/StatusCode.js"></script>
  <script src="../src/runtime/FontProperties.js"></script>
  <script src="../src/runtime/TextProperties.js"></script>
  <script src="../src/runtime/FontMetrics.js"></script>
  <script src="../src/runtime/InterpolatedFontMetrics.js"></script>
  <script src="../src/builder/MetricsExpander.js"></script>
  <script src="../src/runtime/CharacterSets.js"></script>
  <script src="../src/runtime/AtlasPositioning.js"></script>
  <script src="../src/runtime/AtlasImage.js"></script>
  <script src="../src/runtime/AtlasData.js"></script>
  <script src="../src/builder/AtlasReconstructionUtils.js"></script>
  <script src="../src/utils/AtlasCellDimensions.js"></script>
  <script src="../src/runtime/TightAtlasReconstructor.js"></script>
  <script src="../src/runtime/AtlasDataStore.js"></script>
  <script src="../src/runtime/FontMetricsStore.js"></script>
  <script src="../src/runtime/FontLoaderBase.js"></script>
  <script src="../src/platform/FontLoader-browser.js"></script>
  <script src="../src/runtime/BitmapText.js"></script>

  <script>
    // Configure font directory
    BitmapText.setFontDirectory('../font-assets/');
    const isFileProtocol = window.location.href.includes("file://");

    // Load only size 9px - all small sizes will interpolate from this
    const fontProps9 = new FontProperties(1, "Arial", "normal", "normal", 9);
    const textProps = new TextProperties({
      isKerningEnabled: true,
      textBaseline: 'bottom',
      textAlign: 'left',
      textColor: '#000000'
    });

    console.log('Loading size 9px metrics (used for all sizes < 9px)...');

    BitmapText.loadFont(fontProps9.idString, {
      isFileProtocol,
      onProgress: (loaded, total) => console.log(`Loaded ${loaded} of ${total} files`)
    }).then(() => {
      console.log('‚úÖ Size 9px loaded successfully');
      renderDemos();
    }).catch((error) => {
      console.error('‚ùå Failed to load fonts:', error);
    });

    function renderDemos() {
      renderSmallSizes();
      renderMeasurementDemo();
    }

    function renderSmallSizes() {
      const canvas = document.getElementById('small-sizes-canvas');
      const ctx = canvas.getContext('2d');

      // Clear with white background
      ctx.fillStyle = 'white';
      ctx.fillRect(0, 0, canvas.width, canvas.height);

      // Test various small sizes plus 9
      const testSizes = [0, 1, 2, 3, 4, 5, 6, 7, 8, 8.5, 9];
      const testText = "The quick brown fox jumps over the lazy dog.";
      let yPos = 40;

      testSizes.forEach(size => {
        const fontProps = new FontProperties(1, "Arial", "normal", "normal", size);

        // Draw size label
        ctx.fillStyle = '#666';
        ctx.font = '14px Arial';
        ctx.fillText(`Size ${size}px:`, 10, yPos);

        // Draw text using BitmapText
        const result = BitmapText.drawTextFromAtlas(
          ctx,
          testText,
          120,
          yPos + 10,
          fontProps,
          textProps
        );

        // Log status and draw annotation
        if (result.rendered) {
          if (size === 9) {
            console.log(`‚úÖ Size ${size}px rendered from atlas`);
            ctx.fillStyle = '#4CAF50';
            ctx.font = '12px Arial';
            ctx.fillText('(‚úì rendered from atlas)', 300, yPos + 5);
          } else {
            console.log(`‚úÖ Size ${size}px rendered (placeholder mode)`);
            if (result.status.placeholdersUsed) {
              ctx.fillStyle = '#4CAF50';
              ctx.font = '12px Arial';
              ctx.fillText('(placeholders)', 300, yPos + 5);
            }
          }
        } else {
          console.error(`‚ùå Size ${size}px failed:`, getStatusDescription(result.status));
          ctx.fillStyle = '#F44336';
          ctx.font = '12px Arial';
          ctx.fillText(`Error: ${getStatusDescription(result.status)}`, 300, yPos + 5);
        }

        yPos += 45;
      });
    }

    function renderMeasurementDemo() {
      const canvas = document.getElementById('measurement-canvas');
      const ctx = canvas.getContext('2d');

      // Clear with white background
      ctx.fillStyle = 'white';
      ctx.fillRect(0, 0, canvas.width, canvas.height);

      // Test various small sizes plus 9
      const testSizes = [0, 1, 2, 3, 4, 5, 6, 7, 8, 8.5, 9];
      const testText = "The quick brown fox jumps over the lazy dog.";
      let yPos = 40;

      testSizes.forEach(size => {
        const fontProps = new FontProperties(1, "Arial", "normal", "normal", size);

        // Draw size label
        ctx.fillStyle = '#666';
        ctx.font = '14px Arial';
        ctx.fillText(`Size ${size}px:`, 10, yPos);

        // Measure text
        const measureResult = BitmapText.measureText(testText, fontProps, textProps);

        if (measureResult.status.code === StatusCode.SUCCESS) {
          const metrics = measureResult.metrics;
          console.log(`üìè Size ${size}px measurements:`, metrics);

          // Draw the text
          const xPos = 120;
          const result = BitmapText.drawTextFromAtlas(
            ctx,
            testText,
            xPos,
            yPos + 10,
            fontProps,
            textProps
          );

          // Draw measurement box
          ctx.strokeStyle = '#2196F3';
          ctx.lineWidth = 1;
          ctx.strokeRect(
            xPos,
            yPos + 10 - metrics.fontBoundingBoxAscent,
            metrics.width,
            metrics.fontBoundingBoxAscent + metrics.fontBoundingBoxDescent
          );

          // Draw measurements on the same line (third column)
          ctx.fillStyle = '#1976D2';
          ctx.font = '11px Arial';
          const metricsText = `width: ${metrics.width.toFixed(2)}px  ascent: ${metrics.fontBoundingBoxAscent.toFixed(2)}px  descent: ${metrics.fontBoundingBoxDescent.toFixed(2)}px`;
          ctx.fillText(metricsText, 500, yPos + 5);
        } else {
          console.error(`‚ùå Size ${size}px measurement failed:`, getStatusDescription(measureResult.status));
          ctx.fillStyle = '#F44336';
          ctx.font = '12px Arial';
          ctx.fillText(`Error: ${getStatusDescription(measureResult.status)}`, 120, yPos + 5);
        }

        yPos += 45;
      });
    }
  </script>
</body>

</html>
