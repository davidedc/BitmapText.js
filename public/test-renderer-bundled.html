<!--
You'll need to serve this file from a server to avoid CORS issues, because if you open the page from filesystem
the dynamic loading of the images seems to create security issues when you then try to read the pixels from the canvas
where you painted the images.

So use a simple server like this:
  python -m http.server
and then open the page from the browser at:
  http://localhost:8000/test-renderer-bundled.html
-->

<!DOCTYPE html>
<html lang="">

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Uniform Pixel Perfect JS Canvas Text Renderer (Bundled)</title>
  <style>
    body {
      padding: 0;
      margin: 0;
      background-color: #d4ffd4;
    }
    canvas {
      font-smooth: never;
      -webkit-font-smoothing: none;
      -moz-osx-font-smoothing: none;
      margin-left: 3px;
    }
    .bundle-info {
      background: #e8f4f8;
      padding: 10px;
      margin: 10px;
      border-radius: 5px;
      border-left: 4px solid #2196F3;
      font-size: 14px;
    }
    .progress-container {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      height: 4px;
      background: rgba(0, 0, 0, 0.1);
      z-index: 9999;
      transition: opacity 0.5s ease-out;
    }
    .progress-container.complete {
      opacity: 0;
      pointer-events: none;
    }
    .progress-fill {
      height: 100%;
      width: 0%;
      background: linear-gradient(90deg, #4CAF50, #45a049);
      transition: width 0.2s ease-out;
    }
    .progress-text {
      position: absolute;
      top: 6px;
      left: 50%;
      transform: translateX(-50%);
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      font-size: 11px;
      color: #333;
      background: rgba(255, 255, 255, 0.9);
      padding: 2px 8px;
      border-radius: 3px;
      white-space: nowrap;
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
    }
  </style>
</head>

<body>
  <div id="loadingProgressBar" class="progress-container">
    <div class="progress-fill"></div>
    <div class="progress-text">Loading fonts: 0/0 (0%)</div>
  </div>

  <div class="bundle-info">
    <strong style="color: #2196F3;">Production Bundle:</strong> This demo uses the minified runtime bundle (32KB) instead of 17 separate script tags.
    <br>See <code>test-renderer.html</code> for the debug version with individual source files.
  </div>

  <main>
    <div id="selectors"></div>
    <div id="testCopyCanvases" style="clear:both;"></div>
  </main>
</body>

<!-- Test utilities (NOT in bundle) -->
<script src="../src/utils/timing.js"></script>

<script >
  const maxFontSize_px = 96;
  const minFontSize_px = 0;  // Rendering/testing context: can test interpolated sizes from 0px
  const fontSizeIncrement_px = 0.5;
  let specsDefault;
  function updatePageContent() {
    showGlyphs();
  }
</script>

<!-- PRODUCTION: Single minified bundle (~32KB) -->
<script src="../dist/bitmaptext.min.js"></script>

<!-- Additional test utilities (NOT in bundle) -->
<script src="../src/utils/HashStore.js"></script>
<script src="../test/data/reference-hashes.js"></script>
<script src="../src/utils/canvas-extensions.js"></script>
<script src="../test/utils/test-copy.js"></script>
<script src="../test/utils/draw-test-text.js"></script>
<script src="../src/utils/dom-cleanup.js"></script>
<script src="../test/utils/show-glyphs.js"></script>
<script src="../src/ui/components/copy-choice.js"></script>
<script src="../src/ui/components/pixel-density.js"></script>
<script src="../src/ui/components/font-family-dropdown.js"></script>
<script src="../src/ui/components/font-style-dropdown.js"></script>
<script src="../src/ui/components/font-weight-dropdown.js"></script>
<script src="../src/ui/components/size-buttons.js"></script>
<script src="../src/ui/base-ui.js"></script>

<!-- FontManifest.js is included in dist/bitmaptext.min.js - do not load separately -->
<script src="../font-assets/font-registry.js"></script>

<script>
  // Ensure everything is loaded before starting
  console.log("BitmapText available:", typeof BitmapText !== 'undefined');
  console.log("FontManifest available:", typeof FontManifest !== 'undefined' && FontManifest.count() > 0);

  if (typeof BitmapText === 'undefined') {
    console.error("BitmapText is not defined. Check that BitmapText.js loaded properly.");
  } else if (typeof FontManifest === 'undefined' || FontManifest.count() === 0) {
    console.error("FontManifest is not available or contains no fonts. Check that FontManifest.js and font-registry.js loaded properly.");
  } else {
    // Load all fonts from manifest and trigger test rendering
    startTiming('loadingFontData');

    // Determine protocol for image loading
    const isFileProtocol = window.location.href.includes("file://");

    // Configure font directory (required since we're in public/ subdirectory)
    BitmapText.setFontDirectory('../font-assets/');

    // Load all fonts using static API
    console.log("Using font registry IDs:", FontManifest.allFontIDs());

    BitmapText.loadFonts(FontManifest.allFontIDs(), {
      isFileProtocol,
      onProgress: (loaded, total) => {
        const progressBar = document.getElementById('loadingProgressBar');
        if (progressBar) {
          const percentage = Math.round((loaded / total) * 100);
          const progressFill = progressBar.querySelector('.progress-fill');
          const progressText = progressBar.querySelector('.progress-text');

          if (progressFill) progressFill.style.width = percentage + '%';
          if (progressText) progressText.textContent = `Loading fonts: ${loaded}/${total} (${percentage}%)`;
        }
        console.log(`loadedScripts: ${loaded} out of ${total}`);
      }
    }).then(() => {
      console.log("⏱️ loadingFontData took " + stopTiming('loadingFontData') + " milliseconds");
      console.log("All metrics loaded to BitmapText");

      // Hide progress bar with fade-out animation
      const progressBar = document.getElementById('loadingProgressBar');
      if (progressBar) {
        progressBar.classList.add('complete');
        // Remove from DOM after fade-out completes
        setTimeout(() => progressBar.remove(), 600);
      }

      startTiming('drawTestText');
      const fontProperties = getFontPropertiesFromUI();
      drawTestText_withStandardClass(fontProperties);
      console.log("⏱️ drawTestText took " + stopTiming('drawTestText') + " milliseconds");
    }).catch(error => {
      console.error("Font loading failed:", error);

      // Show error state in progress bar
      const progressBar = document.getElementById('loadingProgressBar');
      if (progressBar) {
        progressBar.querySelector('.progress-fill').style.background = '#f44336';
        progressBar.querySelector('.progress-text').textContent = 'Loading failed - check console';
        progressBar.querySelector('.progress-text').style.color = '#f44336';
      }
    });
  }
</script>


</html>