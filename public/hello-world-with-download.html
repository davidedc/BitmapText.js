<!DOCTYPE html>
<html lang="">

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>BitmapText.js - Hello World with Download</title>
  <style>
    body {
      padding: 20px;
      font-family: Arial, sans-serif;
      background-color: #f5f5f5;
    }

    h1 {
      margin-bottom: 20px;
      color: #333;
    }

    canvas {
      border: 1px solid #ccc;
      background: white;
      margin-top: 10px;
      display: block;
    }

    .controls {
      margin-top: 20px;
      padding: 15px;
      background: white;
      border: 1px solid #ccc;
      border-radius: 4px;
    }

    button {
      padding: 10px 20px;
      margin: 5px;
      background: #4CAF50;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 14px;
    }

    button:hover {
      background: #45a049;
    }

    button:disabled {
      background: #ccc;
      cursor: not-allowed;
    }

    .info {
      margin-top: 10px;
      padding: 10px;
      background: #e7f3fe;
      border-left: 4px solid #2196F3;
    }

    .status {
      margin-top: 10px;
      padding: 10px;
      font-family: monospace;
      font-size: 12px;
    }

    .success { background: #d4edda; border-left: 4px solid #28a745; }
    .warning { background: #fff3cd; border-left: 4px solid #ffc107; }
    .error { background: #f8d7da; border-left: 4px solid #dc3545; }
  </style>
</head>

<body>
  <h1>BitmapText.js - Canvas Download Demo</h1>
  <p>This demo renders "Hello World" and provides download options for verification.</p>

  <canvas id="demo-canvas" width="400" height="150"></canvas>

  <div class="controls">
    <h3>Download Options</h3>
    <button id="download-dataurl-btn" disabled>Download PNG (toDataURL)</button>
    <button id="download-blob-btn" disabled>Download PNG (toBlob)</button>
    <button id="render-btn" disabled>Re-render Text</button>

    <div class="info">
      <strong>About the methods:</strong>
      <ul>
        <li><strong>toDataURL</strong>: Converts canvas to Base64-encoded PNG URL (simple, more memory)</li>
        <li><strong>toBlob</strong>: Asynchronously creates binary PNG Blob (efficient, better for large canvases)</li>
      </ul>
    </div>
  </div>

  <div id="status-area"></div>

  <!-- Essential dependencies -->
  <script src="../src/runtime/StatusCode.js"></script>
  <script src="../src/runtime/FontProperties.js"></script>
  <script src="../src/runtime/TextProperties.js"></script>
  <script src="../src/runtime/FontMetrics.js"></script>
  <script src="../src/builder/MetricsExpander.js"></script>
  <script src="../src/runtime/AtlasPositioning.js"></script>
  <script src="../src/runtime/AtlasImage.js"></script>
  <script src="../src/runtime/AtlasData.js"></script>
  <script src="../src/builder/AtlasReconstructionUtils.js"></script>
  <script src="../src/utils/AtlasCellDimensions.js"></script>
  <script src="../src/runtime/TightAtlasReconstructor.js"></script>
  <script src="../src/runtime/AtlasDataStore.js"></script>
  <script src="../src/runtime/FontMetricsStore.js"></script>
  <script src="../src/runtime/FontLoaderBase.js"></script>
  <script src="../src/platform/FontLoader-browser.js"></script>
  <script src="../src/runtime/BitmapText.js"></script>

  <script>
    // Configuration
    const canvas = document.getElementById('demo-canvas');
    const ctx = canvas.getContext('2d');
    const statusArea = document.getElementById('status-area');

    const dataURLBtn = document.getElementById('download-dataurl-btn');
    const blobBtn = document.getElementById('download-blob-btn');
    const renderBtn = document.getElementById('render-btn');

    // Font properties
    const fontProperties = new FontProperties(1, "Arial", "normal", "normal", 19);

    // Configure font directory
    BitmapText.setFontDirectory('../font-assets/');

    // Status logging
    function logStatus(message, type = 'info') {
      const statusDiv = document.createElement('div');
      statusDiv.className = `status ${type}`;
      statusDiv.textContent = message;
      statusArea.appendChild(statusDiv);
      console.log(message);
    }

    // Render function
    function renderText() {
      // Clear canvas
      ctx.fillStyle = 'white';
      ctx.fillRect(0, 0, canvas.width, canvas.height);

      // Render black text (fast path)
      const blackProps = new TextProperties({
        isKerningEnabled: true,
        textBaseline: 'bottom',
        textAlign: 'left',
        textColor: '#000000'
      });

      const result1 = BitmapText.drawTextFromAtlas(
        ctx,
        "Hello World (Black)",
        10,
        50,
        fontProperties,
        blackProps
      );

      // Render blue text (colored slow path)
      const blueProps = new TextProperties({
        isKerningEnabled: true,
        textBaseline: 'bottom',
        textAlign: 'left',
        textColor: '#0000FF'
      });

      const result2 = BitmapText.drawTextFromAtlas(
        ctx,
        "Hello World (Blue)",
        10,
        90,
        fontProperties,
        blueProps
      );

      // Render red text with different alignment
      const redProps = new TextProperties({
        isKerningEnabled: true,
        textBaseline: 'bottom',
        textAlign: 'center',
        textColor: '#FF0000'
      });

      const result3 = BitmapText.drawTextFromAtlas(
        ctx,
        "Centered Red",
        200,
        130,
        fontProperties,
        redProps
      );

      if (result1.status.code === StatusCode.SUCCESS &&
          result2.status.code === StatusCode.SUCCESS &&
          result3.status.code === StatusCode.SUCCESS) {
        logStatus('✅ All text rendered successfully!', 'success');
      } else {
        logStatus('⚠️ Some text rendered with issues', 'warning');
      }
    }

    // Download using toDataURL
    function downloadViaDataURL() {
      try {
        // Convert canvas to base64 PNG data URL
        const dataURL = canvas.toDataURL('image/png');

        // Create download link
        const link = document.createElement('a');
        link.download = `bitmaptext-render-dataurl-${Date.now()}.png`;
        link.href = dataURL;
        link.click();

        logStatus(`✅ Downloaded via toDataURL (${Math.round(dataURL.length / 1024)}KB base64)`, 'success');
      } catch (error) {
        logStatus(`❌ toDataURL failed: ${error.message}`, 'error');
      }
    }

    // Download using toBlob (more efficient)
    function downloadViaBlob() {
      canvas.toBlob(function(blob) {
        try {
          if (!blob) {
            throw new Error('Failed to create blob');
          }

          // Create download link
          const url = URL.createObjectURL(blob);
          const link = document.createElement('a');
          link.download = `bitmaptext-render-blob-${Date.now()}.png`;
          link.href = url;
          link.click();

          // Clean up
          setTimeout(() => URL.revokeObjectURL(url), 100);

          logStatus(`✅ Downloaded via toBlob (${Math.round(blob.size / 1024)}KB)`, 'success');
        } catch (error) {
          logStatus(`❌ toBlob failed: ${error.message}`, 'error');
        }
      }, 'image/png');
    }

    // Initialize
    const isFileProtocol = window.location.href.includes("file://");

    logStatus('Loading font...', 'info');

    BitmapText.loadFont(fontProperties.idString, {
      isFileProtocol,
      onProgress: (loaded, total) => {
        logStatus(`Loading progress: ${loaded}/${total}`, 'info');
      }
    }).then(() => {
      logStatus('✅ Font loaded successfully', 'success');

      // Enable buttons
      dataURLBtn.disabled = false;
      blobBtn.disabled = false;
      renderBtn.disabled = false;

      // Initial render
      renderText();

      // Add event listeners
      dataURLBtn.addEventListener('click', downloadViaDataURL);
      blobBtn.addEventListener('click', downloadViaBlob);
      renderBtn.addEventListener('click', () => {
        statusArea.innerHTML = '';
        renderText();
      });

    }).catch(error => {
      logStatus(`❌ Font loading failed: ${error.message}`, 'error');
    });
  </script>
</body>

</html>
